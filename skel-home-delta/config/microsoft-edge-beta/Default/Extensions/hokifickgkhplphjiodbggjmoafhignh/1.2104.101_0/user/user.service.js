!function(){"use strict";angular.module("app.user",[]).factory("userService",["$q","$log","$injector","constants","storage","notification","msidUserService","editorUtils",function(e,r,t,n,i,a,o,s){Utilities.isBackgroundContext()&&BrowserHandler.runtime.onMessage.addListener((function(e,t,i){switch(e.activity){case n.ACTIVITY.LOGOUT.NAME:return U().then(()=>{i()}),!0;case n.ACTIVITY.AUTHENTICATION.NAME:return m(e.type).then(e=>{i(e)}),!0;case n.ACTIVITY.AUTHORIZATION.NAME:return t.id===chrome.runtime.id&&e.close&&(t.tab&&t.tab.id&&BrowserHandler.tabs.remove(t.tab.id),delete e.close),l(T(e)).then(()=>{i()}),!0;case n.ACTIVITY.REQUEST_TOKEN.NAME:return S(e.data.url,e.data.type,e.data.inIFrame).then(e=>{i(e)}),!0;case n.ACTIVITY.REFRESH_ROAMING_TOKEN.NAME:{const e=t.tab&&t.tab.id;return void 0!==e&&e>=0&&async function e({tabId:t,shouldOverrideMaxTabs:i}){const a=await v();if(!await s.isFeatureFlagEnabled("enableRoamingDictionary")||a===n.USER_TYPE.NONE||void 0===t&&t<0||Y.has(t)&&!i)return!1;if(B++,Y.add(t),Y.size>1&&!i)return!1;let o,u;try{o=a===n.USER_TYPE.MSA?await async function(e){let r=await c(e,n.MSACONFIG.ROAMING_URL,n.MSACONFIG.ROAMING_SCOPE,!0);if(!r)throw"Roaming token not found!";return r.access_token="t="+r.access_token,r}(a):await async function(e){let r=await c(e,n.O365CONFIG.ROAMING_URL,n.O365CONFIG.ROAMING_URL,!1);if(!r)throw"Roaming token not found!";return r}(a)}catch(n){if(r.error("failed to fetch Roaming Info:",n),B<3)return e({tabId:t,shouldOverrideMaxTabs:!0})}if(B=0,o){const e=new Date(0);e.setUTCSeconds(o.expires_on),u={accessToken:o.access_token,expiresOn:e}}let l=Array.from(Y);Y.clear();for(const e of l)BrowserHandler.tabs.sendMessage(e,{eventId:"roamingTokenRefreshed",data:[{address:void 0,message:u}]});return!!o}({tabId:e,shouldOverrideMaxTabs:!1}),!0}default:return}}));async function c(e,t,i,a){var o={};if(!(o=await h(e)))return r.error("userService.acquireToken - Invalid type"),Promise.reject("Invalid userType");!i&&o.getResourceForEndpoint&&(i=o.getResourceForEndpoint(t));var s={};try{if((s=await b(t,i))&&s.access_token&&!k(s.expires_on))return r.info(`Using cached token with resource:'${i}'${t?" for "+t:""} `),s;if(r.info(`Requesting new token with resource:'${i}'${t?" for "+t:""}`),!(s=await async function(e,t,i){if(!e)return r.error("userService.requestAccessToken - Invalid type"),Promise.reject("Invalid userType");const a=await async function(){return x("refresh_token")}();if(a)return async function(e,t,i){if(!e)return r.error("userService.refreshAccessToken - Invalid type"),Promise.reject("Invalid userType");var a=e.getConfig();a.params.grant_type=n.OAUTH.REFRESH_TOKEN,a.params.resource=t,a.params.refresh_token=i;var o={method:"POST",url:a.tokenUrl,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:new URLSearchParams(a.params).toString()};return await u(o)}(e,t,a);const o=await v();var s=await L(o);if(e.requestAccessToken)var c=await e.requestAccessToken(t,s,i);return c}(o,i,a)))return Promise.reject("No tokens available");await R(o,t,s)}catch(n){r.error(`${Error().stack.split("\n")[2].trim()} failed. reason: ${n}, userType: ${e}, endpoint: ${t}, resource: ${i}`)}return s&&s.access_token&&s.expires_on&&!k(s.expires_on)?s:null}async function u(e){if(!e)return Promise.reject("Invalid Request");const r=t.get("$http");var n=(new Error).stack;return(await r(e).then(e=>e,r=>Promise.reject(`httpRequest failed for url: ${e.url} stack:\n ${n}`))).data}async function l(e){const t=e.type;var n=void 0,i=await h(t);i?(e.id_token&&(n=await y(e.id_token)),e.access_token&&(await R(i,i.getConfig().userInfoUrl,e),n||(n=await v()),await G(i,e.id_token)),e.error&&r.error(`userService.authenticate - authentication returned error: ${e.error} description: ${e.error_description} request: ${JSON.stringify(e)}`)):r.error("userService.authenticate - Invalid type")}async function d(){return Promise.all([i.remove("accessToken"),i.remove("refreshToken"),i.remove("userInfo"),i.remove("userType"),i.remove("identity"),i.remove("postUpsellAnnouncementVisible"),i.remove("postUpsellAnnouncementDismissed"),i.remove("postUpsellAnnouncementHadSubscription")])}async function f(){return Promise.all([i.remove("userExcludedUrls"),i.remove("showSynonyms"),i.remove("enableTelemetry"),i.remove("enableEditor"),i.remove("enableSpelling"),i.remove("enableGrammar"),i.remove("enableRefinements"),i.remove("proofingLanguage"),i.remove("proofingLanguages"),i.remove("defaultProofingLanguageInitialized"),i.remove("proofingLanguageListInitialized")])}async function E(){var e=await i.get(["userType","identity"]);return e.identity&&e.userType&&e.userType!==n.USER_TYPE.NONE}async function p(){var e=await i.get(["userType","identity"]),r=e.userType;if(r&&r!==n.USER_TYPE.NONE&&e.identity){var t=e.identity[r];if(t&&t.userInfo){var a=t.userInfo;switch(r){case n.USER_TYPE.O365:return a.activeExperiences&&Array.isArray(a.activeExperiences)?a.activeExperiences.some(e=>"OfficeProPlus"===e)?n.LICENSE_TYPE.SUBSCRIPTION:n.LICENSE_TYPE.NO_LICENSE:n.LICENSE_TYPE.SUBSCRIPTION;case n.USER_TYPE.MSA:if(!a.activeSubscriptionProduct)return;return"none"===a.activeSubscriptionProduct?n.LICENSE_TYPE.NO_LICENSE:n.LICENSE_TYPE.SUBSCRIPTION;case n.USER_TYPE.NONE:default:return}}}}async function v(){return(await i.get("userType")).userType||n.USER_TYPE.NONE}async function y(e){var t="";if(Object.values(n.USER_TYPE).includes(e))t=e;else{var a=function(e){var t=e.scopes||e.scope;if(t&&t.includes("wl."))return{type:n.USER_TYPE.MSA};var i=e.id_token||e;if(!i)return{type:n.USER_TYPE.NONE};const a={"9188040d-6c67-4c5b-b112-36a304b66dad":{type:n.USER_TYPE.MSA,audience:"prod"},"4925308c-f164-4d2d-bc7e-0631132e9375":{type:n.USER_TYPE.MSA,audience:"ppe"},"72f988bf-86f1-41af-91ab-2d7cd011db47":{type:n.USER_TYPE.O365,audience:"prod",domain:"microsoft.com"},"f686d426-8d16-42db-81b7-ab578e110ccd":{type:n.USER_TYPE.O365,audience:"ppe",domain:"microsoft.com"}};try{const{header:e,payload:t}=function(e){var t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(!t||t.length<4)return r.error("The returned id_token is not parseable."),null;var n=JSON.parse($(t[1])),i=JSON.parse($(t[2]));return{header:n,payload:i}}(i);var o={tenant:t.tid};if(a.hasOwnProperty(o.tenant)){var s=a[o.tenant];o=Object.assign(o,s)}else o.type=n.USER_TYPE.O365;return o}catch(e){return{type:n.USER_TYPE.MSA}}}(e);t=a.type,delete a.type;var o={[t]:a},s=await N();if(angular.equals(s,{})){const e=await g(!1);r.trackEvent("IdentityPopulated",{clientId:e})}O(s,o),await i.set({identity:s})}return t!==n.USER_TYPE.NONE&&await i.set({userType:t}),t}function T(e){e.state&&(e.state=decodeURIComponent(e.state));var[r,t,n]=e.state.split("|");return t&&(e.type=t),e}async function S(e,t,i){return new Promise(async(a,o)=>{if(Utilities.isBackgroundContext()){const p=(e=new URL(e)).searchParams;for(const e of["state","nonce"]){var s=p.get(e);s||(s=j()),"state"===e&&t&&(s+="|"+t+"|"+n.APPINFO_NAME),p.set(e,s)}var c=void 0,u=void 0;function l(){if(BrowserHandler.runtime.onMessage.removeListener(d),c){var e=document.getElementById(c);e&&e.parentNode.removeChild(e)}}function d(t,i,s){if(t.activity===n.ACTIVITY.AUTHORIZATION.NAME){r.debug("auth listener received: "+e);const n=T(t);n&&n.state===v||(r.error("auth response received with error: null response or state not matching"),o(n)),n.error?r.error("auth response received with error: "+n.error):n.access_token?r.info("auth listener received successfully"):r.error("auth response received with unknown error"),u&&clearTimeout(u),delete t.activity,l(),a(n)}}const v=p.get("state"),y=p.get("scope");r.info("loading auth url "+(i?"in iframe":"")),BrowserHandler.runtime.onMessage.addListener(d);var f=await L();if(f&&f.email&&!p.has("login_hint")&&p.set("login_hint",f.email),i){p.set("prompt","none"),c="authFrame!"+y;const t=6e4;u=setTimeout(()=>{r.warn(`userService.authInFrame timed out after ${t} ms`),l(),o("Timed out waiting for response from iFrame")},t);var E=document.getElementById(c);E||((E=document.createElement("iframe")).setAttribute("id",c),E.style.visibility="hidden",E.style.position="absolute",E.style.width=E.style.height="0",E.style.border="0",E.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms"),document.body.appendChild(E),E.src=e.toString())}else BrowserHandler.tabs.create({url:e.toString()})}else BrowserHandler.runtime.sendMessage({activity:"requestToken",data:{url:e,type:t,inIFrame:i}},e=>{a(e)})})}async function g(e){const r=await i.get("clientId"),t=s.readSettingValueOrUndefined(r,"clientId");if(!t&&e){const e=j();return s.writeEditorSettingValue("clientId",e),e}return t}async function I(...e){const r=await g(!0),t=function(){const e=browser.runtime.getManifest();return{storeId:browser.runtime.id,languageUxId:browser.i18n.getUILanguage(),extensionId:e.version}}(),i={appId:n.APP_ID,...t},a={method:"POST",url:n.LINKS.FLIGHT_INFO_URL,headers:{"Content-Type":"application/json","X-UserId":r},data:i},o=await u(a),s={};for(const r of e)s[r]=!!o&&!!o.FeatureFlags&&!!o.FeatureFlags[r]&&"true"===o.FeatureFlags[r].toLowerCase();return s}function w(t,i){var a=e.defer();a.resolve(Utilities.isNotUndefinedOrNull(i)?i:function(r){Utilities.isUndefinedOrNull(r)&&(r=n.LINKS.PROGRESSPAGE_URL);var t=e.defer();return BrowserHandler.windows.getAll((function(e){0===e.length?BrowserHandler.windows.create({url:r,type:"normal"},(function(e){t.resolve(e.tabs[0].id)})):BrowserHandler.tabs.create({url:r},(function(e){t.resolve(e.id)}))})),t.promise}(t)),a.promise.then((function(e){Utilities.isUndefinedOrNull(e)?r.warn(String.format("BackgroundController.openFileUrlInTab(): tabIdPromise null or undefined")):BrowserHandler.tabs.update(e,{url:t})}))}async function m(e){d();var t=await h(e);if(t.handleLogin)return t.handleLogin(service);var n=t.getConfig().loginUrl;if(n)return S(n,t.type);r.error("userService.login - Invalid type")}async function U(){const e=await v();var t=await h(e);if(d(),f(),t.handleLogout)await t.handleLogout(service);else{var n=t.getConfig().logoutUrl;if(!n)return void r.error("userService.logout - Invalid type");var i={method:"GET",url:n};await u(i)}r.debug("userService.logout - "+e)}async function _(e){var r=await x("service",e);return r||n.USER_SERVICE_TYPE.MSID}async function h(e){var t=null;return Object.values(n.USER_SERVICE_TYPE).includes(e)||(e=await _(e)),-1!==e.indexOf(n.USER_SERVICE_TYPE.MSID)?t=o:r.error("userService.userService - Invalid type - "+e),t}async function N(){var e=await i.get("identity");return e&&e.identity?e.identity:{}}function O(e,t){for(var[n,i]of Object.entries(t))i&&(e[n]&&"none"!==e[n]&&"none"!==i?typeof i==typeof e[n]?Array.isArray(i)?i.forEach((r,t)=>{e[n].indexOf(r)<0&&e[n].push(r)}):"object"!=typeof i?e[n]=i:O(e[n],i):r.warn(`skipping ${n} due to conflicting types`):e[n]=i)}function P(e){return new URL(e).origin}async function R(e,t,a){if(a.expires_in&&!a.expires_on&&(a.expires_on=Utilities.getCurrentTime()+Number(a.expires_in)),t){var o=await v();if(o===n.USER_TYPE.NONE&&(o=await y(a)),o!==n.USER_TYPE.NONE){var s=decodeURIComponent(a.scope).toLowerCase().split(/[ +]/);for await(const e of s){var c=e.match(/(^https:\/\/[\.\w]*(?:\S+\/))/i);if(c){t=c[c.index];break}}t=P(t),a.resource&&a.resource!==t&&(r.info(`saveTokens ${t} does not match ${a.resource}`),t=a.resource);var u={[o]:{id_token:a.id_token,refresh_token:a.refresh_token,service:e.type,resources:{[t]:{access_token:a.access_token,expires_in:a.expires_in,expires_on:a.expires_on,scope:s}}}},l=await N();O(l,u),await i.set({identity:l})}else r.error("userService.saveTokens - unable to resolve userType")}else r.error("userService.saveTokens - endpoint not provided")}function A(e,r){if(!e)return!0;Array.isArray(e)||(e=e.toLowerCase().split(/[ +]/));for(const t of e)if(!r.includes(t))return!1;return!0}async function b(e,t){if(e){e=P(e);try{var n=await x("resources");if(n[e]){var i=n[e];if(e===t)return i;if(i&&A(t,i.scope))return i;delete n[e]}for(const e in n)if(A(t,e.scope))return e;return null}catch(e){return null}}else r.error("userService.getAccessToken - endpoint not provided")}async function L(e){return x("userInfo",e)}async function x(e,r){r||(r=await v());var t=await N();return t[r]&&t[r][e]?t[r][e]:null}async function C(e,r,t){var n=await N(),a={};n[e]&&n[e].userInfo&&!t&&(a=n[e].userInfo),O(a,r),n[e]&&(n[e].userInfo=a,await i.set({identity:n}))}function k(e){var r=Utilities.getCurrentTime();return!(e&&e>r+120)}async function M(e){var t={},i={method:"GET",url:n.MSACONFIG.LICENSE_ENDPOINT,headers:{"X-UserType":e.type}};try{var a=await u(i);if(a){var o=await v();t={activeSubscriptionProduct:a.ActiveSubscriptionProduct?a.ActiveSubscriptionProduct:"none"},await C(o,t)}}catch(e){r.error("Call to Shell consumer license service failed.")}return t}async function F(e){var t={},i={method:"GET",url:n.O365CONFIG.LICENSE_ENDPOINT,headers:{"X-UserType":e.type}};try{var a=await u(i);if(a&&a.ActiveExperiences){var o=await v();t={activeExperiences:a.ActiveExperiences},await C(o,t)}}catch(e){r.error("Call to Shell commercial license service failed. error:"+JSON.stringify(e))}}let Y=new Set,B=0;async function H(e,t,i){return r.trackEvent("FetchLicenseInfo",{isRefresh:i,userType:e}),await(e===n.USER_TYPE.MSA?M:F)(t)}async function G(e,r){var t=await v(),i=await e.lookupUserInfo(r);BrowserHandler.runtime.sendMessage({activity:n.ACTIVITY.USERINFO_AVAILABLE.NAME,data:i}),!i.email&&i.userPrincipalName&&(i.email=i.userPrincipalName),await C(t,i,!0),V(e),await H(t,e,!1)}function $(e){return e=e.replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(e)))}async function V(e){const t=e.type,i=await v();var a=e.getConfig()[i===n.USER_TYPE.MSA?"msaPhotoUrl":"aadPhotoUrl"];if(a){var o={method:"GET",url:a,responseType:"blob",headers:{"X-UserType":t}};try{const e=await u(o);r.trackEvent("UserService_GotServerPhoto",{userType:i});var s=new FileReader;s.onload=async()=>(C(i,{photo:s.result}),s.result),s.readAsDataURL(e)}catch(e){return null}}}function j(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let r=performance.now();const t=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===e?t:3&t|8).toString(16)}))}return{acquireToken:c,onInstall:async function(){try{const{enableSignInExperiment:e,enableAutomaticSignIn:t}=await I("enableSignInExperiment","enableAutomaticSignIn");if(e){const e=await g(!1);r.trackEvent("AutoSignInExperiment",{isAutoSignInEnabled:t,clientId:e})}const i=t&&!await E();w(function(e){return Utilities.isChrome()?e?n.LINKS.POST_INSTALL_CHROME_AUTO_URL:n.LINKS.POST_INSTALL_CHROME_URL:Utilities.isEdge()?e?n.LINKS.POST_INSTALL_EDGE_AUTO_URL:n.LINKS.POST_INSTALL_EDGE_URL:n.POST_INSTALL_URL}(i),null),i&&m(n.USER_SERVICE_TYPE.MSID)}catch(e){r.error("failed to auto sign in: "+e)}},clearToken:d,isLoggedIn:E,isUpsellFeatureEnabled:async function(){return await s.isFeatureFlagEnabled("enableUpsellFeature")},isMultiLangFeatureEnabled:async function(){return await s.isFeatureFlagEnabled("enableMultiLanguageSupport")},isUpsellUser:async function(){var e=await i.get(["userType","identity"]),r=e.identity&&e.userType&&e.userType===n.USER_TYPE.MSA,t=e.identity?e.identity[n.USER_TYPE.MSA]:void 0;return!!(r&&t&&t.userInfo&&t.userInfo.activeSubscriptionProduct)&&"none"===t.userInfo.activeSubscriptionProduct},isPremiumUser:async function(){return await p()===n.LICENSE_TYPE.SUBSCRIPTION},isUnsignedInEditorEnabled:async function(){var e=await s.isFeatureFlagEnabled("enableUnsignedInEditor"),r=await s.isFeatureFlagEnabled("enableSuppressUnsignedInEditorForMultiLang");const t=(await new Promise(e=>{BrowserHandler.i18n.getAcceptLanguages(r=>e(r))})).reduce((e,r)=>{const t=r.split("-");if(t.length>0){const r=t[0];e.add(r)}return e},new Set);return e&&(!r||t.size<=1)},getEndpointUrlForCurrentUser:async function(e){const r=await v();if(!r||r===n.USER_TYPE.NONE)return null;var t=await h(r);return t?t.getConfig()[e]:null},getUserType:v,getUserInfo:L,getUserPhoto:async function(){var e=await v();if(e===n.USER_TYPE.NONE)return r.warn("UserService.getUserPhoto: no signed-in user"),Promise.reject(n.RECENTS.ERROR.UNSUPPORTED_USER_TYPE);var t=await L(e);return t&&t.photo?(r.trackEvent("UserService_GotLocalPhoto",{userType:e}),t.photo):Promise.reject("No photo in local storage")},httpRequest:u,navigateToAuthEndpoint:S,saveUserInfo:C,waitForUserInfo:async function(e){return new Promise(async t=>{var i=await L(e);if(Utilities.isNotUndefinedOrNull(i))return t(i);BrowserHandler.runtime.onMessage.addListener(s);var a=Utilities.isExtensionInTestingMode()?n.TIMEOUT.USER_INFO_LOOKUP_TEST:n.TIMEOUT.USER_INFO_LOOKUP,o=setTimeout(()=>{r.warn(String.format("userService.waitForUserInfo timed out after {0} ms - {1}",n.TIMEOUT.USER_INFO_LOOKUP,e)),c(),t(i)},a);function s(e){e.activity===n.ACTIVITY.USERINFO_AVAILABLE.NAME&&(c(),clearTimeout(o),t(e.data))}function c(){BrowserHandler.runtime.onMessage.removeListener(s)}})},getLicenseType:p,authorize:l,getAccessToken:b,getPhotoFromServer:V,login:m,logout:U,lookupUserInfo:G,getTenant:async function(e){return x("tenant",e)},refreshLicense:async function(){r.debug("Refreshing license");var e=await v();if(e===n.USER_TYPE.NONE)return{refreshed:!1};var t=await _(e),i=await h(t);return null===i?{refreshed:!1}:{refreshed:!0,data:await H(e,i,!0)}},clearUserSettings:f}}])}();