!function(){"use strict";angular.module("app.diagnostics",[]).service("telemetry",["$injector","constants","ariaTelemetry",function(e,t,n){var i=[n],r=async function(n){var i=e.get("userService");Utilities.isUndefinedOrNull(n)&&(n={}),n.pii=[];var r=Utilities.getManifest();r&&(n.appVersion=r.version);var a=BrowserHandler.i18n.getUILanguage();Utilities.isNotUndefinedOrNull(a)&&(n.language=a),n["AppInfo.Name"]=t.APPINFO_NAME;var s=await i.getUserType(),l=AWTLogManager.getSemanticContext();if(s===t.USER_TYPE.NONE)return l.setUserId("","",""),n;if(s===t.USER_TYPE.O365){var d=await i.getTenant(s);Utilities.isNotUndefinedOrNull(d)&&(n.Tenant_Id=d)}n.Identity_Provider=s;var o=await i.getUserInfo(s);return Utilities.isUndefinedOrNull(o)?(l.setUserId("","",""),n):(Utilities.isNotUndefinedOrNull(o.id)&&(n["Data.User_Id"]=o.id,l.setUserId(o.id)),n)},a=function(){var t=e.get("$q"),n=e.get("storage"),i=t.defer();return n.get("enableTelemetry").then((function(e){i.resolve(Utilities.isUndefinedOrNull(e)||!0===function(e,t){if(e[t]){var n=JSON.parse(e[t]);if(void 0!==n.value)return JSON.parse(n.value)}}(e,"enableTelemetry"))})),i.promise};return{getEnabledSetting:function(){return a()},setEnabledSetting:function(n){if(Utilities.isBackgroundContext()){!function(t){e.get("storage").set({enableTelemetry:JSON.stringify({value:JSON.stringify(t),lastUpdate:Date.now(),manualOverride:!1})})}(n);for(var r=0;r<i.length;++r)i[r].setEnabledSetting(n)}else BrowserHandler.runtime.sendMessage({activity:t.ACTIVITY.TELEMETRY.NAME,command:t.TELEMETRY.COMMAND.CHANGE_TELEMETRY_VALUE,enabled:n})},trackEvent:async function(e,n,a){if(!angular.isUndefined(e)&&angular.isString(e))if(Utilities.isBackgroundContext()){n=await r(n);for(var s=0;s<i.length;++s){var l=angular.extend({},n);i[s].trackEvent(e,l,a)}}else BrowserHandler.runtime.sendMessage({activity:t.ACTIVITY.TELEMETRY.NAME,command:t.TELEMETRY.COMMAND.TRACK_EVENT,eventName:e,properties:n,measurements:a})},trackTrace:async function(e,n){if(!angular.isUndefined(e)&&angular.isString(e))if(Utilities.isBackgroundContext()){n=await r(n);for(var a=0;a<i.length;++a){var s=angular.extend({},n);i[a].trackTrace(e,s)}}else BrowserHandler.runtime.sendMessage({activity:t.ACTIVITY.TELEMETRY.NAME,command:t.TELEMETRY.COMMAND.TRACK_TRACE,message:e,properties:n})}}}])}();