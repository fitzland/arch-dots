!function(){"use strict";angular.module("app.editor",[]).controller("EditorController",["$scope","$log","constants","storage","userService","localize","editorUtils","languageUtils",function(e,t,i,n,r,o,a,d){var l=this,s=Object.freeze({undefined:0,enabled:1,disabled:2});function u(){if(l.isLoggedIn){var e=l.upsellFeatureEnabled&&l.editorIsUpsellUser?"EditorRefinementsGoPremiumTooltip":"EditorRefinementsTooltip";l.refinementsTooltipText=o.getLocalizedString(e)}else l.refinementsTooltipText=o.getLocalizedString("ebx_RefinementTooltip")}function g(e){"Enter"===e.key&&(l.editorSpelling=!l.editorSpelling,l.onEditorSpellingChange())}function c(e){"Enter"===e.key&&(l.editorGrammar=!l.editorGrammar,l.onEditorGrammarChange())}function m(e){"Enter"===e.key&&(l.editorRefinements=!l.editorRefinements,l.onEditorRefinementsChange())}function b(e){l.currentTabUrl=e.url,l.currentHostName=e.hostname,l.editorDisableShow=!1,l.editorEnableShow=!1,l.editorSiteBlockedShow=!1,l.currentHostName?(l.editorSiteBlockedShow=a.siteIsBlocked(l.currentTabUrl),l.editorIsBlockedLabel=a.getFormattedLocalizedString("EditorIsBlockedOnThisSiteLabel",l.currentHostName),l.editorSiteBlockedShow?l.storage.get(["websitesWithNativeIntegration"]).then((function(e){var t=a.readSettingValueOrUndefined(e,"websitesWithNativeIntegration");a.siteHasNativeIntegration(l.currentTabUrl,t)&&(l.editorIsBlockedLabel=a.getFormattedLocalizedString("EditorNativeSupportOnThisSiteLabel",l.currentHostName))})):l.storage.get(["userExcludedUrls","disabledWebSites"]).then((function(e){var t=l.currentHostName;l.userExcludedUrls=a.readSettingValueOrUndefined(e,"userExcludedUrls"),l.disabledWebSites=a.readSettingValueOrUndefined(e,"disabledWebSites"),l.editorDisableLabel=a.getFormattedLocalizedString("DisableEditorOnThisSiteLabel",t),l.editorEnableLabel=a.getFormattedLocalizedString("EnableEditorOnThisSiteLabel",t),l.editorIsDisabledLabel=a.getFormattedLocalizedString("EditorIsDisabledOnThisSiteLabel",t);var i=a.isHostNameExcluded(t,l.userExcludedUrls);a.isUrlExcluded(l.currentTabUrl,l.disabledWebSites)?(l.editorSiteBlockedShow=!0,l.editorDisableShow=!1,l.editorEnableShow=!1):(l.editorSiteBlockedShow=!1,l.editorDisableShow=!i,l.editorEnableShow=i),l.animationsEnabled=!0}))):l.animationsEnabled=!0}function E(){l.editorGrammar=l.editorGrammarEnabled&&l.isLoggedIn}function S(){l.editorRefinements=l.editorRefinementsEnabled&&l.editorIsPremiumUser&&l.isLoggedIn}function f(){t.trackEvent("EditorUserInteraction",{name:"SpellingChange"}),a.writeEditorSettingValue("enableSpelling",l.editorSpelling)}function U(){t.trackEvent("EditorUserInteraction",{name:"GrammarChange"}),a.writeEditorSettingValue("enableGrammar",l.editorGrammar)}function h(){t.trackEvent("EditorUserInteraction",{name:"RefinementsChange"}),a.writeEditorSettingValue("enableRefinements",l.editorRefinements)}function v(){t.trackEvent("EditorUserInteraction",{name:"TurnOnClick"}),a.writeEditorSettingValue("enableEditor",!0),l.editorEnabled=!0}function L(){t.trackEvent("EditorUserInteraction",{name:"SettingsClick"}),a.openOptionsPage()}function p(e){var t=document.getElementById(e),i=0;if(t){var n=()=>{t.offsetParent?t.focus():i<10&&(i+=1,window.setTimeout(n,100))};window.setTimeout(n,0)}}function I(){t.trackEvent("EditorUserInteraction",{name:"DisableClick"});var e=a.getHostnameOnlyUrl(l.currentTabUrl);e&&(l.userExcludedUrls.push(e),a.writeEditorSettingValue("userExcludedUrls",l.userExcludedUrls),l.editorDisableShow=!1,l.editorEnableShow=!0,p("editor-enable-button"))}function k(){t.trackEvent("EditorUserInteraction",{name:"EnableClick"}),l.userExcludedUrls=l.userExcludedUrls.filter((function(e){return a.getUrlInfo(e).hostname!==l.currentHostName})),a.writeEditorSettingValue("userExcludedUrls",l.userExcludedUrls),l.editorDisableShow=!0,l.editorEnableShow=!1,p("editor-disable-button")}function w(){t.trackEvent("EditorUserInteraction",{name:"GoPremiumClick"}),Utilities.navigateToUrlWithNewTab(l.constants.LINKS.EDITOR_GO_PREMIUM_URL,!0)}l.onLoad=function(){t.debug("Loading EditorController"),l.storage.get(["editorClientState","enableEditor","enableSpelling","enableGrammar","enableRefinements","proofingLanguages"]).then((function(e){var t=a.readSettingValueOrUndefined(e,"editorClientState");void 0!==t&&(l.editorAvailable=t===s.enabled);var i=a.readSettingValueOrUndefined(e,"enableEditor");void 0!==i&&(l.editorEnabled=i);var n=a.readSettingValueOrUndefined(e,"enableSpelling");void 0!==n&&(l.editorSpelling=n);var r=a.readSettingValueOrUndefined(e,"enableGrammar");void 0!==r&&(l.editorGrammarEnabled=r,E());var o=a.readSettingValueOrUndefined(e,"enableRefinements");void 0!==o&&(l.editorRefinementsEnabled=o,S());var u=a.readSettingValueOrUndefined(e,"proofingLanguages");if(void 0!==u){l.proofingLanguages=[];for(var g=0;g<u.length;g+=1){var c=u[g],m=d.getLanguageName(c),b=void 0!==m?m:c,f=a.getFormattedLocalizedString("EditorProofingLanguageAriaLabel",b);l.proofingLanguages.push({name:b,ariaLabel:f})}}})),a.getCurrentTabHostName().then(b),l.userService.isLoggedIn().then((function(e){l.isLoggedIn=e,E(),S(),u()})),l.userService.isUpsellFeatureEnabled().then((function(e){l.upsellFeatureEnabled=e,u()})),l.userService.isMultiLangFeatureEnabled().then((function(e){l.isMultiLangFeatureEnabled=e})),l.userService.isUpsellUser().then((function(e){l.editorIsUpsellUser=e,u()})),l.userService.isPremiumUser().then((function(e){l.editorIsPremiumUser=e,S()}))},l.constants=i,l.storage=n,l.userService=r,l.localize=o,l.animationsEnabled=!1,l.editorIsBlockedLabel="",l.editorAvailable=!1,l.editorDisableShow=!1,l.editorEnableShow=!1,l.editorIsUpsellUser=!1,l.upsellFeatureEnabled=!1,l.isMultiLangFeatureEnabled=!1,l.editorSiteBlockedShow=!1,l.editorIsPremiumUser=!1,l.isLoggedIn=!1,l.editorRefinementsEnabled=!1,l.editorGrammarEnabled=!1,l.editorEnabled=!0,l.editorSpelling=!0,l.editorGrammar=!0,l.editorRefinements=!0,l.proofingLanguages=[],u(),l.grammarTooltipText=o.getLocalizedString("ebx_addGrammarChecking")+o.getLocalizedString("ebx_enhancedUpsellCategoriesComma")+o.getLocalizedString("ebx_signIntoEditor"),l.onEditorTurnOnClick=v,l.onEditorSettingsClick=L,l.onEditorDisableClick=I,l.onEditorEnableClick=k,l.onEditorGoPremiumClick=w,l.onEditorSpellingChange=f,l.onEditorGrammarChange=U,l.onEditorRefinementsChange=h,l.onEditorSpellingKeyPress=g,l.onEditorGrammarKeyPress=c,l.onEditorRefinementsKeyPress=m}])}();