!function(){"use strict";angular.module("app.popup",[]).controller("PopupController",["$timeout","$scope","$log","$document","constants","storage","userService","localize",function(e,n,t,i,o,s,r,c){var l=this,a=null,u=null,d=null;function S(){t.trackEvent("PopupSignOutLinkClick"),BrowserHandler.runtime.sendMessage({activity:o.ACTIVITY.LOGOUT.NAME,type:n.userType}),l.hasSignedIn=l.constants.SIGNINSTATUS.NONE,n.userType=l.constants.USER_TYPE.NONE,s.remove("localRecentDocuments"),e((function(){l.focusFirstElement()}),0)}l.accountPanelOpened=!1,l.filesSelected=null,l.focusVisible=!1,l.webRedirectInputChecked=!1,l.telemetryInputChecked=!1,l.onLine=!0,l.username="",l.email="",l.profilePicture="",l.rtl=Utilities.isRTL(),l.isChrome=Utilities.isChrome(),l.refinementsTooltipVisible=!1,l.signoutTooltipVisible=!1,l.editorFeatureEnabled=Utilities.isEditorEnabled(),l.onMenuItemClick=function(e){l.currentViewMode=l.currentViewMode===e?l.constants.MENU_VIEWMODE.NONE:l.currentViewMode=e},l.onSignOutClick=function(){l.currentViewMode=l.constants.MENU_VIEWMODE.NONE,l.hasSignedIn===l.constants.SIGNINSTATUS.SIGNEDIN&&S(),window.location.reload()},l.onWelcomeSignInClick=async function(e,n){return t.trackEvent("PopupSignInLinkClick",{eventFrom:n}),window.close(),new Promise(async n=>{BrowserHandler.runtime.sendMessage({activity:l.constants.ACTIVITY.AUTHENTICATION.NAME,type:e},e=>{n()})})},l.onProfileClick=function(){l.accountPanelOpened=!l.accountPanelOpened},l.onPopupKeydown=function(e){"Tab"!==e.key&&" "!==e.key||l.focusVisible||(l.focusVisible=!0)},l.onSignOutLinkClick=S,l.onSignupLinkClick=function(){t.trackEvent("PopupSignupLinkClick"),Utilities.navigateToUrlWithNewTab(l.constants.LINKS.SIGNUP,!0)},l.onWebRedirectInputChange=function(){l.webRedirectInputChecked=!l.webRedirectInputChecked,l.storage.set({webRedirect_disabled:!l.webRedirectInputChecked}),t.trackEvent("PopupWebRedirectChecked",{enabled:l.webRedirectInputChecked})},l.onTelemetryInputChange=function(){l.telemetryInputChecked=!l.telemetryInputChecked,t.setEnabledSetting(l.telemetryInputChecked),t.trackEvent("PopupTelemetryInputChecked",{enabled:l.telemetryInputChecked})},l.onFeedbackClick=function(){Utilities.navigateToUrlWithNewTab(BrowserHandler.extension.getURL(l.constants.LINKS.FEEDBACK_URL),!0)},l.openSupportPage=function(){Utilities.navigateToUrlWithNewTab(o.LINKS.LOGIN_SUPPORT_URL,!0)},l.openMyAccountPage=function(){var e=n.userType===l.constants.USER_TYPE.O365?l.constants.LINKS.MYACCOUNT_O365_URL:l.constants.LINKS.MYACCOUNT_MSA_URL;Utilities.navigateToUrlWithNewTab(e,!0)},l.constants=o,l.storage=s,l.userService=r,l.localize=c,l.hasSignedIn=l.constants.SIGNINSTATUS.UNKNOWN,l.isUnsignedInEditorEnabled=!1,l.showRefinementsTooltip=function(){u=e((function(){l.refinementsTooltipVisible=!0}),500)},l.hideRefinementsTooltip=function(){e.cancel(u),l.refinementsTooltipVisible=!1},l.showGrammarTooltip=function(){a=e((function(){l.grammarTooltipVisible=!0}),500)},l.hideGrammarTooltip=function(){e.cancel(a),l.grammarTooltipVisible=!1},l.showSignoutTooltip=function(){d=e((function(){l.signoutTooltipVisible=!0}),500)},l.hideSignoutTooltip=function(){e.cancel(d),l.signoutTooltipVisible=!1},l.focusFirstElement=function(){var e=l.hasSignedIn===l.constants.SIGNINSTATUS.NONE?".login_button":"#editor-spelling-toggle",n=document.querySelector(e);n&&(l.focusVisible=!0,n.focus())},l.onMouseMove=function(){l.focusVisible=!1},l.onMouseEnter=function(){l.focusVisible=!1,n.$apply()},l.currentViewMode=l.constants.MENU_VIEWMODE.NONE,n.userType=l.constants.USER_TYPE.NONE,l.menuItems=[{id:"AccountInfo",label:"AccountLabel",iconClass:"o365-Icon--person2",viewMode:l.constants.MENU_VIEWMODE.ACCOUNT},{id:"Settings",label:"SettingsLabel",iconClass:"o365-Icon--gear",viewMode:l.constants.MENU_VIEWMODE.SETTINGS}],i.ready((function(){e((function(){t.trackEvent("PopupPageLoad")}));for(var n=document.querySelectorAll(".ms-Spinner"),i=0;i<n.length;i++)new fabric.Spinner(n[i]);var o=document.querySelectorAll(".ms-CheckBox");for(i=0;i<o.length;i++)new fabric.CheckBox(o[i]);e((function(){l.focusFirstElement()}))})),document.addEventListener("mousemove",l.onMouseMove),document.addEventListener("mouseenter",l.onMouseEnter),l.userService.isUnsignedInEditorEnabled().then(e=>{l.isUnsignedInEditorEnabled=e,n.$apply()}),s.get(["userType","identity"]).then(e=>{var i=e&&e.identity&&e.userType!==o.USER_TYPE.NONE;l.hasSignedIn=i?l.constants.SIGNINSTATUS.SIGNEDIN:l.constants.SIGNINSTATUS.NONE,l.hasSignedIn>l.constants.SIGNINSTATUS.NONE&&(t.debug("PopupController.refreshSignInStatus(): Method start"),l.userService.getUserType().then((async function(e){if(t.debug(String.format("PopupController.getSignInStatus(): hasSignedIn: {0}",e)),t.trackEvent("PopupSignedIn",{userType:e}),n.userType=e,l.hasSignedIn=e===l.constants.USER_TYPE.NONE?l.constants.SIGNINSTATUS.NONE:l.constants.SIGNINSTATUS.SIGNEDIN,l.hasSignedIn===l.constants.SIGNINSTATUS.SIGNEDIN){var i=await l.userService.waitForUserInfo(e);Utilities.isUndefinedOrNull(i)?t.warn("self.UserService.getUserInfo(): userInfo is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):Utilities.isUndefinedOrNull(i.email)?t.warn("self.UserService.getUserInfo(): userInfo.email is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):(l.username=i.displayName,l.email=i.email,r.getUserPhoto().then((function(e){l.profilePicture=e,n.$apply()}),(function(e){l.profilePicture="",t.info(String.format("PopupController.getUserPhoto: Profile Picture Error - {0}",e))})))}})))}),t.getEnabledSetting().then((function(e){t.setEnabledSetting(e)}))}])}();