!function(){"use strict";angular.module("app.user",[]).factory("userService",["$q","$log","$injector","constants","storage","notification","msidUserService","editorUtils",function(e,r,t,n,a,i,o,s){Utilities.isBackgroundContext()&&BrowserHandler.runtime.onMessage.addListener((function(e,t,a){switch(e.activity){case n.ACTIVITY.LOGOUT.NAME:return U().then(()=>{a()}),!0;case n.ACTIVITY.AUTHENTICATION.NAME:return w(e.type).then(e=>{a(e)}),!0;case n.ACTIVITY.AUTHORIZATION.NAME:return t.id===chrome.runtime.id&&e.close&&(t.tab&&t.tab.id&&BrowserHandler.tabs.remove(t.tab.id),delete e.close),l(T(e)).then(()=>{a()}),!0;case n.ACTIVITY.REQUEST_TOKEN.NAME:return S(e.data.url,e.data.type,e.data.inIFrame).then(e=>{a(e)}),!0;case n.ACTIVITY.REFRESH_ROAMING_TOKEN.NAME:{const e=t.tab&&t.tab.id;return void 0!==e&&e>=0&&async function e({tabId:t,shouldOverrideMaxTabs:a}){const i=await v();if(!await s.isFeatureFlagEnabled("enableRoamingDictionary")||i===n.USER_TYPE.NONE||void 0===t&&t<0||Y.has(t)&&!a)return!1;if(B++,Y.add(t),Y.size>1&&!a)return!1;let o,u;try{o=i===n.USER_TYPE.MSA?await async function(e){let r=await c(e,n.MSACONFIG.ROAMING_URL,n.MSACONFIG.ROAMING_SCOPE,!0);if(!r)throw"Roaming token not found!";return r.access_token="t="+r.access_token,r}(i):await async function(e){let r=await c(e,n.O365CONFIG.ROAMING_URL,n.O365CONFIG.ROAMING_URL,!1);if(!r)throw"Roaming token not found!";return r}(i)}catch(n){if(r.error("failed to fetch Roaming Info"),B<3)return e({tabId:t,shouldOverrideMaxTabs:!0})}if(B=0,o){const e=new Date(0);e.setUTCSeconds(o.expires_on),u={accessToken:o.access_token,expiresOn:e}}let l=Array.from(Y);Y.clear();for(const e of l)BrowserHandler.tabs.sendMessage(e,{eventId:"roamingTokenRefreshed",data:[{address:void 0,message:u}]});return!!o}({tabId:e,shouldOverrideMaxTabs:!1}),!0}default:return}}));async function c(e,t,a,i){var o={};if(!(o=await h(e)))return r.error("userService.acquireToken - Invalid type"),Promise.reject("Invalid userType");!a&&o.getResourceForEndpoint&&(a=o.getResourceForEndpoint(t));var s={};try{if((s=await A(t,a))&&s.access_token&&!k(s.expires_on))return s;if(!(s=await async function(e,t,a){if(!e)return r.error("userService.requestAccessToken - Invalid type"),Promise.reject("Invalid userType");const i=await async function(){return x("refresh_token")}();if(i)return async function(e,t,a){if(!e)return r.error("userService.refreshAccessToken - Invalid type"),Promise.reject("Invalid userType");var i=e.getConfig();i.params.grant_type=n.OAUTH.REFRESH_TOKEN,i.params.resource=t,i.params.refresh_token=a;var o={method:"POST",url:i.tokenUrl,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:new URLSearchParams(i.params).toString()};return await u(o)}(e,t,i);const o=await v();var s=await L(o);if(e.requestAccessToken)var c=await e.requestAccessToken(t,s,a);return c}(o,a,i)))return Promise.reject("No tokens available");await R(o,t,s)}catch(n){r.error(`${Error().stack.split("\n")[2].trim()} failed. reason: ${n}, userType: ${e}, endpoint: ${t}, resource: ${a}`)}return s&&s.access_token&&s.expires_on&&!k(s.expires_on)?s:null}async function u(e){if(!e)return Promise.reject("Invalid Request");const r=t.get("$http");var n=(new Error).stack;return(await r(e).then(e=>e,r=>Promise.reject(`httpRequest failed for url: ${e.url} stack:\n ${n}`))).data}async function l(e){const t=e.type;var n=void 0,a=await h(t);a?(e.id_token&&(n=await y(e.id_token)),e.access_token&&(await R(a,a.getConfig().userInfoUrl,e),n||(n=await v()),await G(a,e.id_token)),e.error&&r.error("userService.authenticate - authentication returned error")):r.error("userService.authenticate - Invalid type")}async function d(){return Promise.all([a.remove("accessToken"),a.remove("refreshToken"),a.remove("userInfo"),a.remove("userType"),a.remove("identity"),a.remove("postUpsellAnnouncementVisible"),a.remove("postUpsellAnnouncementDismissed"),a.remove("postUpsellAnnouncementHadSubscription")])}async function f(){return Promise.all([a.remove("userExcludedUrls"),a.remove("showSynonyms"),a.remove("enableTelemetry"),a.remove("enableEditor"),a.remove("enableSpelling"),a.remove("enableGrammar"),a.remove("enableRefinements"),a.remove("enableAutocorrect"),a.remove("proofingLanguage"),a.remove("proofingLanguages"),a.remove("defaultProofingLanguageInitialized"),a.remove("proofingLanguageListInitialized"),a.remove("premiumValuePerLanguage")])}async function E(){var e=await a.get(["userType","identity"]);return e.identity&&e.userType&&e.userType!==n.USER_TYPE.NONE}async function p(){var e=await a.get(["userType","identity"]),r=e.userType;if(r&&r!==n.USER_TYPE.NONE&&e.identity){var t=e.identity[r];if(t&&t.userInfo){var i=t.userInfo;switch(r){case n.USER_TYPE.O365:return i.activeExperiences&&Array.isArray(i.activeExperiences)?i.activeExperiences.some(e=>"OfficeProPlus"===e)?n.LICENSE_TYPE.SUBSCRIPTION:n.LICENSE_TYPE.NO_LICENSE:n.LICENSE_TYPE.SUBSCRIPTION;case n.USER_TYPE.MSA:if(!i.activeSubscriptionProduct)return;return"none"===i.activeSubscriptionProduct?n.LICENSE_TYPE.NO_LICENSE:n.LICENSE_TYPE.SUBSCRIPTION;case n.USER_TYPE.NONE:default:return}}}}async function v(){return(await a.get("userType")).userType||n.USER_TYPE.NONE}async function y(e){var t="";if(Object.values(n.USER_TYPE).includes(e))t=e;else{var i=function(e){var t=e.scopes||e.scope;if(t&&t.includes("wl."))return{type:n.USER_TYPE.MSA};var a=e.id_token||e;if(!a)return{type:n.USER_TYPE.NONE};const i={"9188040d-6c67-4c5b-b112-36a304b66dad":{type:n.USER_TYPE.MSA,audience:"prod"},"4925308c-f164-4d2d-bc7e-0631132e9375":{type:n.USER_TYPE.MSA,audience:"ppe"},"72f988bf-86f1-41af-91ab-2d7cd011db47":{type:n.USER_TYPE.O365,audience:"prod",domain:"microsoft.com"},"f686d426-8d16-42db-81b7-ab578e110ccd":{type:n.USER_TYPE.O365,audience:"ppe",domain:"microsoft.com"}};try{const{header:e,payload:t}=function(e){var t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(!t||t.length<4)return r.error("The returned id_token is not parseable."),null;var n=JSON.parse(V(t[1])),a=JSON.parse(V(t[2]));return{header:n,payload:a}}(a);var o={tenant:t.tid};if(i.hasOwnProperty(o.tenant)){var s=i[o.tenant];o=Object.assign(o,s)}else o.type=n.USER_TYPE.O365;return o}catch(e){return{type:n.USER_TYPE.MSA}}}(e);t=i.type,delete i.type;var o={[t]:i},s=await N();if(angular.equals(s,{})){const e=await g(!1);r.trackEvent("IdentityPopulated",{clientId:e})}P(s,o),await a.set({identity:s})}return t!==n.USER_TYPE.NONE&&await a.set({userType:t}),t}function T(e){e.state&&(e.state=decodeURIComponent(e.state));var[r,t,n]=e.state.split("|");return t&&(e.type=t),e}async function S(e,t,a){return new Promise(async(i,o)=>{if(Utilities.isBackgroundContext()){const p=(e=new URL(e)).searchParams;for(const e of["state","nonce"]){var s=p.get(e);s||(s=j()),"state"===e&&t&&(s+="|"+t+"|"+n.APPINFO_NAME),p.set(e,s)}var c=void 0,u=void 0;function l(){if(BrowserHandler.runtime.onMessage.removeListener(d),c){var e=document.getElementById(c);e&&e.parentNode.removeChild(e)}}function d(t,a,s){if(t.activity===n.ACTIVITY.AUTHORIZATION.NAME){r.debug("auth listener received: "+e);const n=T(t);n&&n.state===v||(r.error("auth response received with error: null response or state not matching"),o(n)),n.error?r.error("auth response received with error"):n.access_token?r.info("auth listener received successfully"):r.error("auth response received with unknown error"),u&&clearTimeout(u),delete t.activity,l(),i(n)}}const v=p.get("state"),y=p.get("scope");r.info("loading auth url "+(a?"in iframe":"")),BrowserHandler.runtime.onMessage.addListener(d);var f=await L();if(f&&f.email&&!p.has("login_hint")&&p.set("login_hint",f.email),a){p.set("prompt","none"),c="authFrame!"+y;const t=6e4;u=setTimeout(()=>{r.warn(`userService.authInFrame timed out after ${t} ms`),l(),o("Timed out waiting for response from iFrame")},t);var E=document.getElementById(c);E||((E=document.createElement("iframe")).setAttribute("id",c),E.style.visibility="hidden",E.style.position="absolute",E.style.width=E.style.height="0",E.style.border="0",E.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms"),document.body.appendChild(E),E.src=e.toString())}else BrowserHandler.tabs.create({url:e.toString()})}else BrowserHandler.runtime.sendMessage({activity:"requestToken",data:{url:e,type:t,inIFrame:a}},e=>{i(e)})})}async function g(e){const r=await a.get("clientId"),t=s.readSettingValueOrUndefined(r,"clientId");if(!t&&e){const e=j();return s.writeEditorSettingValue("clientId",e),e}return t}async function I(...e){const r=await g(!0),t=function(){const e=browser.runtime.getManifest();return{storeId:browser.runtime.id,languageUxId:browser.i18n.getUILanguage(),extensionId:e.version}}(),a={appId:n.APP_ID,...t},i={method:"POST",url:n.LINKS.FLIGHT_INFO_URL,headers:{"Content-Type":"application/json","X-UserId":r},data:a},o=await u(i),s={};for(const r of e)s[r]=!!o&&!!o.FeatureFlags&&!!o.FeatureFlags[r]&&"true"===o.FeatureFlags[r].toLowerCase();return s}function m(t,a){var i=e.defer();i.resolve(Utilities.isNotUndefinedOrNull(a)?a:function(r){Utilities.isUndefinedOrNull(r)&&(r=n.LINKS.PROGRESSPAGE_URL);var t=e.defer();return BrowserHandler.windows.getAll((function(e){0===e.length?BrowserHandler.windows.create({url:r,type:"normal"},(function(e){t.resolve(e.tabs[0].id)})):BrowserHandler.tabs.create({url:r},(function(e){t.resolve(e.id)}))})),t.promise}(t)),i.promise.then((function(e){Utilities.isUndefinedOrNull(e)?r.warn(String.format("BackgroundController.openFileUrlInTab(): tabIdPromise null or undefined")):BrowserHandler.tabs.update(e,{url:t})}))}async function w(e){d();var t=await h(e);if(t.handleLogin)return t.handleLogin(service);var n=t.getConfig().loginUrl;if(n)return S(n,t.type);r.error("userService.login - Invalid type")}async function U(){const e=await v();var t=await h(e);if(d(),f(),t.handleLogout)await t.handleLogout(service);else{var n=t.getConfig().logoutUrl;if(!n)return void r.error("userService.logout - Invalid type");var a={method:"GET",url:n};await u(a)}r.debug("userService.logout - "+e)}async function _(e){var r=await x("service",e);return r||n.USER_SERVICE_TYPE.MSID}async function h(e){var t=null;return Object.values(n.USER_SERVICE_TYPE).includes(e)||(e=await _(e)),-1!==e.indexOf(n.USER_SERVICE_TYPE.MSID)?t=o:r.error("userService.userService - Invalid type - "+e),t}async function N(){var e=await a.get("identity");return e&&e.identity?e.identity:{}}function P(e,t){for(var[n,a]of Object.entries(t))a&&(e[n]&&"none"!==e[n]&&"none"!==a?typeof a==typeof e[n]?Array.isArray(a)?a.forEach((r,t)=>{e[n].indexOf(r)<0&&e[n].push(r)}):"object"!=typeof a?e[n]=a:P(e[n],a):r.warn(`skipping ${n} due to conflicting types`):e[n]=a)}function O(e){return new URL(e).origin}async function R(e,t,i){if(i.expires_in&&!i.expires_on&&(i.expires_on=Utilities.getCurrentTime()+Number(i.expires_in)),t){var o=await v();if(o===n.USER_TYPE.NONE&&(o=await y(i)),o!==n.USER_TYPE.NONE){var s=decodeURIComponent(i.scope).toLowerCase().split(/[ +]/);for await(const e of s){var c=e.match(/(^https:\/\/[\.\w]*(?:\S+\/))/i);if(c){t=c[c.index];break}}t=O(t),i.resource&&i.resource!==t&&(r.info(`saveTokens ${t} does not match ${i.resource}`),t=i.resource);var u={[o]:{id_token:i.id_token,refresh_token:i.refresh_token,service:e.type,resources:{[t]:{access_token:i.access_token,expires_in:i.expires_in,expires_on:i.expires_on,scope:s}}}},l=await N();P(l,u),await a.set({identity:l})}else r.error("userService.saveTokens - unable to resolve userType")}else r.error("userService.saveTokens - endpoint not provided")}function b(e,r){if(!e)return!0;Array.isArray(e)||(e=e.toLowerCase().split(/[ +]/));for(const t of e)if(!r.includes(t))return!1;return!0}async function A(e,t){if(e){e=O(e);try{var n=await x("resources");if(n[e]){var a=n[e];if(e===t)return a;if(a&&b(t,a.scope))return a;delete n[e]}for(const e in n)if(b(t,e.scope))return e;return null}catch(e){return null}}else r.error("userService.getAccessToken - endpoint not provided")}async function L(e){return x("userInfo",e)}async function x(e,r){r||(r=await v());var t=await N();return t[r]&&t[r][e]?t[r][e]:null}async function C(e,r,t){var n=await N(),i={};n[e]&&n[e].userInfo&&!t&&(i=n[e].userInfo),P(i,r),n[e]&&(n[e].userInfo=i,await a.set({identity:n}))}function k(e){var r=Utilities.getCurrentTime();return!(e&&e>r+120)}async function M(e){var t={},a={method:"GET",url:n.MSACONFIG.LICENSE_ENDPOINT,headers:{"X-UserType":e.type}};try{var i=await u(a);if(i){var o=await v();t={activeSubscriptionProduct:i.ActiveSubscriptionProduct?i.ActiveSubscriptionProduct:"none"},await C(o,t)}}catch(e){r.error("Call to Shell consumer license service failed.")}return t}async function F(e){var t={},a={method:"GET",url:n.O365CONFIG.LICENSE_ENDPOINT,headers:{"X-UserType":e.type}};try{var i=await u(a);if(i&&i.ActiveExperiences){var o=await v();t={activeExperiences:i.ActiveExperiences},await C(o,t)}}catch(e){r.error("Call to Shell commercial license service failed.")}}let Y=new Set,B=0;async function H(e,t,a){return r.trackEvent("FetchLicenseInfo",{isRefresh:a,userType:e}),await(e===n.USER_TYPE.MSA?M:F)(t)}async function G(e,r){var t=await v(),a=await e.lookupUserInfo(r);BrowserHandler.runtime.sendMessage({activity:n.ACTIVITY.USERINFO_AVAILABLE.NAME,data:a}),!a.email&&a.userPrincipalName&&(a.email=a.userPrincipalName),await C(t,a,!0),$(e),await H(t,e,!1)}function V(e){return e=e.replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(e)))}async function $(e){const t=e.type,a=await v();var i=e.getConfig()[a===n.USER_TYPE.MSA?"msaPhotoUrl":"aadPhotoUrl"];if(i){var o={method:"GET",url:i,responseType:"blob",headers:{"X-UserType":t}};try{const e=await u(o);r.trackEvent("UserService_GotServerPhoto",{userType:a});var s=new FileReader;s.onload=async()=>(C(a,{photo:s.result}),s.result),s.readAsDataURL(e)}catch(e){return null}}}function j(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let r=performance.now();const t=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===e?t:3&t|8).toString(16)}))}return{acquireToken:c,onInstall:async function(){try{const{enableSignInExperiment:e,enableAutomaticSignIn:t}=await I("enableSignInExperiment","enableAutomaticSignIn");if(e){const e=await g(!1);r.trackEvent("AutoSignInExperiment",{isAutoSignInEnabled:t,clientId:e})}const a=t&&!await E();m(function(e){return Utilities.isChrome()?e?n.LINKS.POST_INSTALL_CHROME_AUTO_URL:n.LINKS.POST_INSTALL_CHROME_URL:Utilities.isEdge()?e?n.LINKS.POST_INSTALL_EDGE_AUTO_URL:n.LINKS.POST_INSTALL_EDGE_URL:n.POST_INSTALL_URL}(a),null),a&&w(n.USER_SERVICE_TYPE.MSID)}catch(e){r.error("failed to auto sign in")}},clearToken:d,isAutocorrectEnabled:async function(){return await s.isFeatureFlagEnabled("enableAutoCorrect")},isLoggedIn:E,isUpsellFeatureEnabled:async function(){return await s.isFeatureFlagEnabled("enableUpsellFeature")},isMultiLangFeatureEnabled:async function(){return await s.isFeatureFlagEnabled("enableMultiLanguageSupport")},isUpsellUser:async function(){var e=await a.get(["userType","identity"]),r=e.identity&&e.userType&&e.userType===n.USER_TYPE.MSA,t=e.identity?e.identity[n.USER_TYPE.MSA]:void 0;return!!(r&&t&&t.userInfo&&t.userInfo.activeSubscriptionProduct)&&"none"===t.userInfo.activeSubscriptionProduct},isPremiumUser:async function(){return await p()===n.LICENSE_TYPE.SUBSCRIPTION},isUnsignedInEditorEnabled:async function(){var e=await s.isFeatureFlagEnabled("enableUnsignedInEditor"),r=await s.isFeatureFlagEnabled("enableSuppressUnsignedInEditorForMultiLang");const t=(await new Promise(e=>{BrowserHandler.i18n.getAcceptLanguages(r=>e(r))})).reduce((e,r)=>{const t=r.split("-");if(t.length>0){const r=t[0];e.add(r)}return e},new Set);return e&&(!r||t.size<=1)},getEndpointUrlForCurrentUser:async function(e){const r=await v();if(!r||r===n.USER_TYPE.NONE)return null;var t=await h(r);return t?t.getConfig()[e]:null},getUserType:v,getUserInfo:L,getUserPhoto:async function(){var e=await v();if(e===n.USER_TYPE.NONE)return r.warn("UserService.getUserPhoto: no signed-in user"),Promise.reject(n.RECENTS.ERROR.UNSUPPORTED_USER_TYPE);var t=await L(e);return t&&t.photo?(r.trackEvent("UserService_GotLocalPhoto",{userType:e}),t.photo):Promise.reject("No photo in local storage")},httpRequest:u,navigateToAuthEndpoint:S,saveUserInfo:C,waitForUserInfo:async function(e){return new Promise(async t=>{var a=await L(e);if(Utilities.isNotUndefinedOrNull(a))return t(a);BrowserHandler.runtime.onMessage.addListener(s);var i=Utilities.isExtensionInTestingMode()?n.TIMEOUT.USER_INFO_LOOKUP_TEST:n.TIMEOUT.USER_INFO_LOOKUP,o=setTimeout(()=>{r.warn(String.format("userService.waitForUserInfo timed out after {0} ms - {1}",n.TIMEOUT.USER_INFO_LOOKUP,e)),c(),t(a)},i);function s(e){e.activity===n.ACTIVITY.USERINFO_AVAILABLE.NAME&&(c(),clearTimeout(o),t(e.data))}function c(){BrowserHandler.runtime.onMessage.removeListener(s)}})},getLicenseType:p,authorize:l,getAccessToken:A,getPhotoFromServer:$,login:w,logout:U,lookupUserInfo:G,getTenant:async function(e){return x("tenant",e)},refreshLicense:async function(){r.debug("Refreshing license");var e=await v();if(e===n.USER_TYPE.NONE)return{refreshed:!1};var t=await _(e),a=await h(t);return null===a?{refreshed:!1}:{refreshed:!0,data:await H(e,a,!0)}},clearUserSettings:f}}])}();